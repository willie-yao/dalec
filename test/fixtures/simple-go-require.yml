#syntax=local/dalec/frontend:test
args:
  VERSION: 1.5.1
  COMMIT: a8ca31655b37214a6038a3e2a53b4c6d81ba21f5
  REVISION: 1

name: go-md2man
version: ${VERSION}
revision: ${REVISION}
packager: Dalec Example
vendor: Dalec Example
license: MIT
description: A tool to convert markdown into man pages (roff).
website: https://github.com/cpuguy83/go-md2man

sources:
  src:
    generate:
      - gomod:
          edits:
            require:
              - github.com/russross/blackfriday/v2:github.com/russross/blackfriday/v2@v2.1.0
    git:
      url: https://github.com/cpuguy83/go-md2man.git
      commit: v2.0.0

  autoscaler:
    generate:
      - gomod:
          paths:
            - vertical-pod-autoscaler
            - cluster-autoscaler
          edits:
            require:
              - github.com/spf13/pflag:github.com/spf13/pflag@v1.0.10
    git:
      url: https://github.com/kubernetes/autoscaler.git
      commit: ${COMMIT}

dependencies:
  build:
    golang:

targets:
  jammy:
    dependencies:
      build:
        golang:
          version:
            - ">= 1.24.0"

build:
  env:
    CGO_ENABLED: "0"
  steps:
    - command: |
        cd src
        go build -o go-md2man .
    - command: |
        set -xe
        cd autoscaler/vertical-pod-autoscaler
        # check that the go.mod is patched with the require directive
        grep -q "github.com/spf13/pflag v1.0.10" go.mod
        # verify the module cache exists
        test -d "${GOMODCACHE}/github.com/spf13/pflag@v1.0.10"
        cd ../cluster-autoscaler
        grep -q "github.com/spf13/pflag v1.0.10" go.mod

artifacts:
  binaries:
    src/go-md2man:

image:
  entrypoint: go-md2man
  cmd: --help

tests:
  - name: Check bin
    files:
      /usr/bin/go-md2man:
        permissions: 0755
